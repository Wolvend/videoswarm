name: Release

on:
  push:
    tags:
      - 'v*'            # ex: v0.2.0, v0.2.0-rc.1
  workflow_dispatch:     # allow manual runs

permissions:
  contents: write        # needed for gh-release
  pull-requests: read

jobs:
  build:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install
        run: npm ci

      - name: Show builder versions
        run: |
          node -v
          npm -v
          npx electron-builder --version || true

      # Linux-only build deps commonly needed by electron-builder
      - name: Install Linux build deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            icnsutils graphicsmagick xz-utils rpm

      # Build per OS (electron-builder under the hood via your scripts)
      - name: Build (electron-builder)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: "false"
          # Optional: more verbose logs
          DEBUG: electron-builder*
        run: npm run electron:dist

      - name: Collect artifacts
        shell: bash
        run: |
          mkdir -p dist_upload
          # Adjust if your output dir differs (electron-builder defaults to dist/)
          cp -r dist/* dist_upload/ || true

      - name: List dist_upload contents
        shell: bash
        run: |
          echo "pwd = $(pwd)"
          ls -la dist_upload || true

      # --- Checksums: Unix
      - name: Generate SHA256 checksums (Unix)
        if: runner.os != 'Windows'
        shell: bash
        working-directory: dist_upload
        run: |
          set -euo pipefail
          : > SHA256SUMS.txt

          files=$(find . -maxdepth 1 -type f -printf '%f\n' || true)
          if [ -z "$files" ]; then
            echo "No files found to hash" >> SHA256SUMS.txt
            exit 0
          fi

          if command -v shasum >/dev/null 2>&1; then
            for f in $files; do
              shasum -a 256 "$f" >> SHA256SUMS.txt || true
            done
          elif command -v sha256sum >/dev/null 2>&1; then
            for f in $files; do
              sha256sum "$f" >> SHA256SUMS.txt || true
            done
          else
            echo "No sha tool found; leaving empty SHA256SUMS.txt"
          fi


      # --- Checksums: Windows (use PowerShell for reliability)
      - name: Generate SHA256 checksums (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        working-directory: dist_upload
        run: |
          if (!(Test-Path .)) { throw "dist_upload not found" }
          $files = Get-ChildItem -File
          if ($files.Count -eq 0) {
            "No files to hash" | Out-File -FilePath SHA256SUMS.txt -Encoding ascii
            exit 0
          }
          $lines = foreach ($f in $files) {
            $hash = (Get-FileHash -Algorithm SHA256 -Path $f.FullName).Hash
            "$hash  $($f.Name)"
          }
          $lines | Out-File -FilePath SHA256SUMS.txt -Encoding ascii

      - name: Upload artifacts (per-OS)
        uses: actions/upload-artifact@v4
        with:
          name: videoswarm-${{ runner.os }}-artifacts
          path: dist_upload

  release:
    name: Draft GitHub Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: collected

      - name: Generate Release Notes (Release Drafter)
        id: notes
        uses: release-drafter/release-drafter@v6
        with:
          disable-autolabeler: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare notes file
        run: |
          printf "%s" "${{ steps.notes.outputs.body }}" > NOTES.md

      - name: Ensure draft release exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.ref_name }}"
          # create if missing; otherwise just update metadata
          if ! gh release view "$TAG" >/dev/null 2>&1; then
            gh release create "$TAG" \
              --draft \
              $([ "$(echo "$TAG" | grep -c -- '-rc')" -gt 0 ] && echo --prerelease) \
              --title "$TAG" \
              --notes-file NOTES.md
          else
            # update notes/title and keep as draft/prerelease as appropriate
            gh release edit "$TAG" \
              --draft \
              $([ "$(echo "$TAG" | grep -c -- '-rc')" -gt 0 ] && echo --prerelease) \
              --title "$TAG" \
              --notes-file NOTES.md
          fi

      - name: Upload assets (clobber if they already exist)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.ref_name }}"
          shopt -s globstar nullglob
          files=(collected/**/*)
          if [ "${#files[@]}" -eq 0 ]; then
            echo "No files found under collected/**/*"
            exit 0
          fi
          # Use forward slashes and upload with clobber to overwrite duplicates
          gh release upload "$TAG" "${files[@]}" --clobber

